let Lookback = 180d;
let SuccessRateWindow = 30d;

let Jobs =
AddonAzureBackupJobs
| where TimeGenerated >= ago(Lookback)
| where tostring(column_ifexists("JobOperation","")) =~ "Backup"
| summarize arg_max(TimeGenerated, *) by JobUniqueId
| extend
    BackupItemUniqueId = tostring(BackupItemUniqueId),
    BackupItemName =
        tostring(coalesce(
            column_ifexists("EntityFriendlyName",""),
            column_ifexists("BackupItemFriendlyName",""),
            column_ifexists("BackupItemName","")
        )),
    JobStatusNorm = tostring(column_ifexists("JobStatus","")),
    IsSuccess = tolower(JobStatusNorm) in ("completed","completedwithwarnings","succeeded","success"),
    VaultName = tostring(coalesce(column_ifexists("VaultName",""), column_ifexists("Vault",""))),
    SubscriptionId = tostring(coalesce(column_ifexists("SubscriptionId",""), column_ifexists("subscriptionId",""))),
    ResourceGroup = tostring(coalesce(column_ifexists("ResourceGroup",""), column_ifexists("resourceGroup","")))
| where isnotempty(BackupItemUniqueId);

let Monthly =
Jobs
| extend Month = startofmonth(TimeGenerated)
| summarize
    total_jobs = count(),
    success_jobs = countif(IsSuccess),
    failed_jobs  = countif(not(IsSuccess)),
    last_success_time = maxif(TimeGenerated, IsSuccess)
  by Month, BackupItemUniqueId, BackupItemName, VaultName, SubscriptionId, ResourceGroup
| extend
    success_rate = iif(total_jobs == 0, real(null), todouble(success_jobs) / todouble(total_jobs)),
    hours_since_last_success = iif(isnull(last_success_time), real(null), datetime_diff("hour", now(), last_success_time)),
    MonthEnd = endofmonth(Month),
    WindowStart = endofmonth(Month) - SuccessRateWindow;

let Trailing30d =
Monthly
| join kind=leftouter (Jobs | project BackupItemUniqueId, TimeGenerated, IsSuccess) on BackupItemUniqueId
| where TimeGenerated between (WindowStart .. MonthEnd)
| summarize
    total_jobs_30d = count(),
    success_jobs_30d = countif(IsSuccess),
    failed_jobs_30d = countif(not(IsSuccess)),
    success_rate_30d_asof_month_end = iif(count() == 0, real(null),
        todouble(countif(IsSuccess)) / todouble(count()))
  by Month, BackupItemUniqueId, BackupItemName, VaultName, SubscriptionId, ResourceGroup,
     total_jobs, success_jobs, failed_jobs, success_rate, last_success_time, hours_since_last_success;

Trailing30d
| order by Month desc
