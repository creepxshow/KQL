let Lookback = 180d;

let Jobs =
AddonAzureBackupJobs
| where TimeGenerated >= ago(Lookback)
| where tostring(column_ifexists("JobOperation","")) =~ "Backup"
| summarize arg_max(TimeGenerated, *) by JobUniqueId
| extend
    BackupItemUniqueId = tostring(BackupItemUniqueId),
    BackupItemName =
        tostring(coalesce(
            column_ifexists("EntityFriendlyName",""),
            column_ifexists("BackupItemFriendlyName",""),
            column_ifexists("BackupItemName","")
        )),
    JobStatusNorm = tostring(column_ifexists("JobStatus","")),
    IsSuccess = tolower(JobStatusNorm) in ("completed","completedwithwarnings","succeeded","success"),
    VaultName = tostring(coalesce(column_ifexists("VaultName",""), column_ifexists("Vault",""))),
    SubscriptionId = tostring(coalesce(column_ifexists("SubscriptionId",""), column_ifexists("subscriptionId",""))),
    ResourceGroup = tostring(coalesce(column_ifexists("ResourceGroup",""), column_ifexists("resourceGroup",""))),
    DurationSecs =
        todouble(coalesce(
            column_ifexists("DurationInSecs", real(null)),
            column_ifexists("DurationInSeconds", real(null)),
            column_ifexists("Duration", real(null))
        )),
    StartTime = todatetime(column_ifexists("StartTime", datetime(null))),
    EndTime   = todatetime(column_ifexists("EndTime", datetime(null)))
| extend
    DurationSecs = iff(isnull(DurationSecs) and isnotnull(StartTime) and isnotnull(EndTime),
                       datetime_diff("second", EndTime, StartTime),
                       DurationSecs)
| where isnotempty(BackupItemUniqueId);

let Monthly =
Jobs
| extend Month = startofmonth(TimeGenerated)
| summarize
    total_jobs = count(),
    success_jobs = countif(IsSuccess),
    failed_jobs  = countif(not(IsSuccess)),
    last_success_time = maxif(TimeGenerated, IsSuccess),
    duration_p50_secs = percentile(DurationSecs, 50),
    duration_p95_secs = percentile(DurationSecs, 95)
  by Month, BackupItemUniqueId, BackupItemName, VaultName, SubscriptionId, ResourceGroup
| extend
    success_rate = iif(total_jobs == 0, real(null), todouble(success_jobs) / todouble(total_jobs)),
    hours_since_last_success = iif(isnull(last_success_time), real(null), datetime_diff("hour", now(), last_success_time));

Monthly
| order by Month desc
